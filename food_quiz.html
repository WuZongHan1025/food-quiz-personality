<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食物人格測驗</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* CSS 樣式開始 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f0f8ff, #e0ffff); /* 更柔和的背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* 隱藏的區塊 */
        .hidden {
            display: none !important;
        }

        /* 歡迎頁面標題和標語 */
        .quiz-section h1,
        .quiz-section h2 { /* 針對所有 h1, h2 標題 */
            color: #4a4a4a;
            font-size: 2.2em;
            margin-bottom: 10px;
            text-align: center; /* 置中 */
            word-break: break-word; /* 允許長單詞換行 */
            overflow-wrap: break-word; /* 允許長單詞換行 */
        }
        .quiz-section .tagline {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        /* 姓名輸入提示樣式 */
        .user-name-input-group {
            margin-bottom: 20px;
            text-align: center;
        }
        .user-name-input-group label {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #555;
            font-weight: bold;
        }
        .input-field {
            width: calc(100% - 40px); /* 考慮 padding */
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: center; /* 輸入框內文字置中 */
        }
        .input-field::placeholder {
            color: #aaa;
        }
        .input-field:focus {
            border-color: #88c0d0;
            outline: none;
            box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.3);
        }

        /* 按鈕通用樣式 */
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            margin: 5px; /* 增加按鈕間距 */
        }

        .primary-btn {
            background-color: #88c0d0; /* 北歐藍 */
            color: white;
            box-shadow: 0 4px 6px rgba(136, 192, 208, 0.3);
        }

        .primary-btn:hover {
            background-color: #639db5;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(136, 192, 208, 0.4);
        }

        .nav-btn {
            background-color: #a3be8c; /* 北歐綠 */
            color: white;
            box-shadow: 0 4px 6px rgba(163, 190, 140, 0.3);
        }

        .nav-btn:hover {
            background-color: #8fa779;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(163, 190, 140, 0.4);
        }

        .secondary-btn {
            background-color: #eceff4; /* 北歐淺灰 */
            color: #4c566a;
            border: 1px solid #d8dee9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .secondary-btn:hover {
            background-color: #d8dee9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* 進度指示器 */
        .progress-indicator {
            text-align: center;
            font-size: 1.1em;
            color: #777;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* 按鈕禁用狀態 */
        .nav-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #ccc; /* 禁用時的背景色 */
            color: #666;
            transform: none; /* 移除 hover 效果 */
            box-shadow: none;
        }
        .nav-btn.disabled:hover {
            background-color: #ccc; /* 禁用時 hover 顏色不變 */
            transform: none;
        }

        /* 選項按鈕 */
        .option-btn {
            background-color: #eceff4;
            color: #4c566a;
            border: 1px solid #d8dee9;
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .option-btn:hover {
            background-color: #d8dee9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .option-btn.selected {
            background-color: #5e81ac; /* 北歐深藍 */
            color: white;
            border-color: #5e81ac;
            box-shadow: 0 4px 8px rgba(94, 129, 172, 0.3);
        }

        /* 問題區塊 */
        .question-block {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: left;
        }

        .question-text {
            font-size: 1.2em;
            color: #3b4252; /* 北歐深灰藍 */
            margin-bottom: 15px;
            font-weight: bold;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 8px; /* 增加選項間距 */
        }

        /* 階段引文 */
        .stage-intro {
            background-color: #e5e9f0; /* 北歐淺灰藍 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 1.05em;
            color: #4c566a;
            line-height: 1.6;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.08);
        }

        /* 導航按鈕容器 */
        .navigation-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding: 0 10px;
        }

        /* 結果頁樣式 */
        .result-display-area { /* 新的截圖區域樣式 */
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px; /* 與下方的回饋區隔開 */
        }

        .result-title {
            color: #3b4252;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .username-highlight {
            color: #bf616a; /* 北歐紅 */
            font-weight: bold;
        }

        .food-personality-name {
            font-size: 2.8em;
            font-weight: bold;
            color: #ebcb8b; /* 北歐黃 */
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .food-personality-name .emoji {
            font-size: 1.2em; /* 讓 emoji 稍微大一點 */
            vertical-align: middle;
            margin-right: 5px;
        }

        .food-description {
            font-size: 1.1em;
            color: #4c566a;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* 新增的兼容性食物網格容器 */
        .compatibility-sections-wrapper {
            display: flex; /* 使用 flexbox 讓兩個區塊並排 */
            flex-wrap: wrap; /* 允許在小螢幕上換行 */
            gap: 20px; /* 兩個區塊之間的間距 */
            margin-top: 25px;
        }

        .compatibility-section {
            flex: 1; /* 讓每個區塊平均分配空間 */
            min-width: 300px; /* 每個區塊的最小寬度，小於此寬度會換行 */
            text-align: left;
            background-color: #eff3f7; /* 輕微背景色 */
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .compatibility-section h3 {
            color: #5e81ac;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid #d8dee9;
            padding-bottom: 5px;
            text-align: center; /* 兼容性區塊標題置中 */
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* 響應式網格：最小寬度 140px，自動適應列數 */
            gap: 15px; /* 食物卡片之間的間距 */
            margin-top: 15px;
        }

        .food-card {
            background-color: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            color: #4c566a;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            text-align: center; /* 卡片內容置中 */
            display: flex; /* 使用 flexbox 垂直排版卡片內容 */
            flex-direction: column;
            align-items: center; /* 水平置中卡片內容 */
            justify-content: center; /* 垂直置中卡片內容 */
        }

        .food-card strong {
            color: #bf616a; /* 強調食物名稱顏色 */
            font-size: 1.1em; /* 讓名稱稍微大一點 */
            margin-bottom: 5px;
        }

        .food-card .emoji {
            font-size: 2.5em; /* 更大的 emoji */
            margin-bottom: 5px;
        }

        .food-card .reason-text {
            font-size: 0.9em;
            color: #555;
        }


        .feedback-section {
            margin-top: 30px;
            text-align: center;
            background-color: #e5e9f0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .feedback-section h3 {
            color: #3b4252;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .feedback-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* 換行顯示按鈕 */
            gap: 15px; /* 按鈕間距 */
        }

        .feedback-buttons button {
            background-color: #88c0d0;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        .feedback-buttons button:hover {
            background-color: #639db5;
            transform: translateY(-1px);
        }
        .feedback-buttons button.active {
            background-color: #a3be8c; /* 選擇後變綠色 */
            transform: scale(1.05);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        .feedback-buttons button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #ccc;
            transform: none;
            box-shadow: none;
        }

        .result-actions {
            margin-top: 25px;
            display: flex;
            justify-content: center; /* 讓按鈕置中 */
            gap: 20px;
        }

        /* 圖片預覽和提示 */
        #image-display-area {
            text-align: center;
            margin-top: 20px;
        }

        #resultImagePreview {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: block; /* 確保圖片獨佔一行並居中 */
            margin: 0 auto;
        }

        /* 手機提示文字 */
        #saveImageHintText {
            font-size: 0.9em;
            color: #777;
            margin-top: 10px;
        }

        /* 結果頁的免責聲明 */
        .disclaimer {
            margin-top: 30px; /* 增加與按鈕的距離 */
            font-size: 0.85em;
            color: #888;
            text-align: center;
        }

        /* 更多詳情頁面樣式 */
        #more-details-container {
            background-color: #fdfdfd;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #more-details-container h2 {
            color: #3b4252;
            font-size: 2em;
            margin-bottom: 20px;
        }
        #more-details-container p {
            font-size: 1.1em;
            color: #4c566a;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        #more-details-container .copy-link-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* 確保在小螢幕上換行 */
        }
        #more-details-container .copy-link-group input {
            flex-grow: 1;
            max-width: 300px;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            background-color: #eceff4;
            color: #4c566a;
        }
        #more-details-container .copy-link-group button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            background-color: #88c0d0;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #more-details-container .copy-link-group button:hover {
            background-color: #639db5;
        }


        /* 手機適配 */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* 減少整體 padding */
            }
            .container {
                padding: 20px 15px;
                border-radius: 10px;
            }
            .quiz-section h1,
            .quiz-section h2 {
                font-size: 1.8em; /* 手機上標題字體縮小 */
            }
            .quiz-section .tagline, .food-description {
                font-size: 1em;
            }
            .question-text {
                font-size: 1.1em;
            }
            .option-btn {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .navigation-btns button {
                flex: 1; /* 手機上按鈕平均分佈 */
                font-size: 1em;
            }
            .feedback-buttons {
                flex-direction: column; /* 手機上回饋按鈕垂直排列 */
                align-items: stretch;
            }
            .feedback-buttons button {
                width: 100%; /* 手機上按鈕佔滿寬度 */
            }
            /* 手機上下載按鈕和長按提示都顯示 */
            #downloadImageBtn {
                display: inline-block; /* 確保按鈕顯示 */
            }
            #saveImageHintText {
                display: block; /* 確保提示顯示 */
            }
            /* 手機上兼容性區塊維持並排，但可能會換行 */
            .compatibility-sections-wrapper {
                flex-direction: row; /* 保持橫排 */
                flex-wrap: wrap; /* 允許換行 */
                justify-content: center; /* 如果換行，讓區塊置中 */
            }
            .compatibility-section {
                min-width: 280px; /* 調整最小寬度，讓手機上也能盡量並排或優雅換行 */
                flex: 1 1 auto; /* 允許縮小和擴大 */
            }
            .food-grid {
                grid-template-columns: 1fr; /* 手機上單欄顯示食物卡片 */
            }
            #more-details-container .copy-link-group {
                flex-direction: column;
            }
            #more-details-container .copy-link-group input {
                max-width: 100%;
            }
        }

        /* 電腦適配 */
        @media (min-width: 769px) {
            /* 電腦上顯示下載按鈕，長按提示也顯示 (如果需要) */
            #downloadImageBtn {
                display: inline-block; /* 確保按鈕顯示 */
            }
            #saveImageHintText {
                display: block; /* 確保提示顯示 */
            }
            .compatibility-sections-wrapper {
                flex-direction: row; /* 保持橫排 */
                flex-wrap: wrap; /* 允許換行 */
            }
            .compatibility-section {
                flex: 1; /* 讓每個區塊平均分配空間 */
                min-width: 300px; /* 確保足夠寬度 */
            }
        }
        /* CSS 樣式結束 */
    </style>
</head>
<body>
    <div class="container">
        <div id="intro-container" class="quiz-section">
            <h1>歡迎來到「食物人格」測驗！</h1>
            <p class="tagline">找出你是哪種風味的食物，探索你的獨特個性！</p>
            <div class="user-name-input-group">
                <label for="userName">請輸入你的**個性名稱**：</label>
                <input type="text" id="userName" placeholder="例如：料理小當家、食神" class="input-field">
            </div>
            <button id="startQuizBtn" class="primary-btn">開始測驗</button>
            <p class="disclaimer">
                免責聲明：本測驗結果僅供娛樂與自我探索，不應被視為專業心理分析。
            </p>
        </div>

        <div id="quiz-container" class="quiz-section hidden">
            <div id="stage-progress" class="progress-indicator"></div>
            <div id="current-stage-content">
                </div>
            <div class="navigation-btns">
                <button id="prevStageBtn" class="nav-btn hidden" data-direction="prev">上一階段</button>
                <button id="nextStageBtn" class="nav-btn" data-direction="next">下一階段</button>
            </div>
        </div>

        <div id="result-container" class="quiz-section hidden">
            <div id="screenshot-area" class="result-display-area">
                <h2 class="result-title">
                    <span id="userNameDisplay" class="username-highlight"></span>，你的風味人格是：
                </h2>
                <p id="final-food-personality" class="food-personality-name"></p>
                <p id="food-personality-description" class="food-description"></p>

                <div class="compatibility-sections-wrapper">
                    <div class="compatibility-section">
                        <h3>和你最合拍的食物：</h3> <div id="suitable-foods-grid" class="food-grid">
                            </div>
                    </div>

                    <div class="compatibility-section">
                        <h3>你可能需要多點理解的食物：</h3> <div id="unsuitable-foods-grid" class="food-grid">
                            </div>
                    </div>
                </div>

                <p class="disclaimer">
                    免責聲明：本測驗結果僅供娛樂與自我探索，不應被視為專業心理分析。
                    <br>請勿將此結果作為任何正式評斷的依據。
                </p>
            </div>

            <div id="image-display-area">
                <img id="resultImagePreview" src="" alt="我的食物人格測驗結果">
                <p id="saveImageHintText">手機用戶：長按上方圖片即可儲存結果</p>
            </div>

            <div id="feedback-section" class="feedback-section">
                <h3>測驗結果是否準確？回饋結束後能看更多分析喔！</h3>
                <div class="feedback-buttons">
                    <button data-feedback="accurate">很準！👍</button>
                    <button data-feedback="somewhat">有點準 🤔</button>
                    <button data-feedback="inaccurate">不準 👎</button>
                </div>
            </div>

            <div class="result-actions">
                <a id="downloadImageBtn" class="secondary-btn" href="#" download="我的食物人格測驗結果.png">下載圖片</a>
                <button id="viewMoreDetailsBtn" class="primary-btn hidden">查看更多詳情</button>
                <button id="restartQuizBtn" class="secondary-btn">重新測驗</button>
            </div>
        </div>

        <div id="more-details-container" class="quiz-section hidden">
            <h2>恭喜你被整</h2>
            <p>
                這是一份完全隨機的心理測驗 趕緊分享給朋友吧 讓他也體驗一下吧！
            </p>
            <div class="copy-link-group">
                <input type="text" id="shareLink" value="https://reurl.cc/W0g405" readonly>
                <button id="copyLinkBtn">複製連結</button>
            </div>
            <button id="restartQuizBtnFromDetails" class="secondary-btn">重新測驗</button>
        </div>
    </div>

    <script>
        // JavaScript 代碼開始

        // DOM 元素引用
        const introContainer = document.getElementById('intro-container');
        const quizContainer = document.getElementById('quiz-container');
        const resultContainer = document.getElementById('result-container');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const userNameInput = document.getElementById('userName');
        const currentStageContent = document.getElementById('current-stage-content');
        const prevStageBtn = document.getElementById('prevStageBtn');
        const nextStageBtn = document.getElementById('nextStageBtn');
        const finalFoodPersonalityElement = document.getElementById('final-food-personality');
        const foodPersonalityDescriptionElement = document.getElementById('food-personality-description');
        // 兼容性食物網格的 DOM 引用
        const suitableFoodsGrid = document.getElementById('suitable-foods-grid');
        const unsuitableFoodsGrid = document.getElementById('unsuitable-foods-grid');

        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackButtons = document.querySelectorAll('#feedback-section .feedback-buttons button');
        const saveImageHintText = document.getElementById('saveImageHintText');
        const resultImagePreview = document.getElementById('resultImagePreview');
        const downloadImageBtn = document.getElementById('downloadImageBtn');
        const screenshotArea = document.getElementById('screenshot-area');

        const viewMoreDetailsBtn = document.getElementById('viewMoreDetailsBtn');
        const moreDetailsContainer = document.getElementById('more-details-container');
        const shareLinkInput = document.getElementById('shareLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const restartQuizBtnFromDetails = document.getElementById('restartQuizBtnFromDetails');


        let currentStageIndex = 0;
        let userName = '';
        let userAnswers = {}; // {globalQuestionIndex: selectedOptionIndex}
        let mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        let enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

        // 測驗數據 (MBTI 和九型人格相關問題)
        const stages = [
            {
                intro: "✨ **階段一：初登場與自我適應** ✨<br>探索你在新環境下的初始反應。",
                questions: [
                    {
                        question: "1. 一覺醒來，你發現自己變成了一塊食物，你的第一反應？",
                        options: [
                            { text: "先觀察周圍環境，不慌不忙", scores: { mbti: { I: 2, S: 1, J: 1 }, enneagram: { 5: 2, 6: 1 } } },
                            { text: "「也太好玩了吧！」立刻想拍 vlog", scores: { mbti: { E: 2, N: 1, P: 1 }, enneagram: { 7: 2, 3: 1 } } },
                            { text: "馬上擬定逃脫計畫", scores: { mbti: { I: 1, N: 2, T: 1, J: 1 }, enneagram: { 1: 2, 8: 1 } } },
                            { text: "淡淡地接受命運，感嘆人生多變", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 9: 1 } } }
                        ]
                    }
                    ,
                    {
                        question: "2. 在這個全新的食物世界，你需要向一群陌生食物自我介紹，你會？",
                        options: [
                            { text: "熱情開場，還幫別人介紹", scores: { mbti: { E: 2, F: 1 }, enneagram: { 2: 2, 7: 1 } } },
                            { text: "簡短講完就想快閃", scores: { mbti: { I: 2, T: 1 }, enneagram: { 5: 2, 6: 1 } } },
                            { text: "講得很哲學，希望有人懂你", scores: { mbti: { I: 1, N: 1, F: 2 }, enneagram: { 4: 2, 9: 1 } } },
                            { text: "偷偷觀察其他人如何做再行動", scores: { mbti: { I: 2, S: 1, J: 1 }, enneagram: { 6: 2, 9: 1 } } }
                        ]
                    },
                    {
                        question: "3.你最希望自己成為怎樣的食物，會讓大家記住你？",
                        options: [
                            { text: "有愛心且被大家需要", scores: { mbti: { E: 1, S: 1, F: 2, J: 1 }, enneagram: { 2: 2, 9: 1 } } },
                            { text: "勇敢且成就非凡", scores: { mbti: { E: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 3: 1 } } },
                            { text: "獨特且充滿創意", scores: { mbti: { I: 1, N: 2, F: 1, P: 1 }, enneagram: { 4: 2, 7: 1 } } },
                            { text: "安穩可靠，值得信賴", scores: { mbti: { I: 1, S: 2, F: 1, J: 1 }, enneagram: { 6: 2, 1: 1 } } }
                        ]
                    },
                ]
            },
            {
                intro: "🤝 **階段二：團隊組建與初次挑戰** 🤝<br>考驗你的領導、協作與應變能力。",
                questions: [
                    {
                        question: "4. 面對即將到來的團隊挑戰，你會選擇在隊伍中扮演什麼角色？",
                        options: [
                            { text: "隊伍裡的助手，協助大家", scores: { mbti: { E: 1, S: 1, F: 2, J: 1 }, enneagram: { 2: 2, 6: 1 } } },
                            { text: "領導者，掌握全局", scores: { mbti: { E: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 3: 1 } } },
                            { text: "觀察者，冷靜分析", scores: { mbti: { I: 2, N: 1, T: 1, P: 1 }, enneagram: { 5: 2, 1: 1 } } },
                            { text: "自由行動者，靈活應變", scores: { mbti: { E: 1, S: 2, P: 1 }, enneagram: { 7: 2, 8: 1 } } }
                        ]
                    },
                    {
                        question: "5. 隊伍中，你被選為隊長，要帶領大家完成一個困難的料理任務，你會？",
                        options: [
                            { text: "公開表決，大家說了算", scores: { mbti: { I: 1, S: 1, F: 2, J: 1 }, enneagram: { 9: 2, 2: 1 } } },
                            { text: "親自規劃戰術與分工", scores: { mbti: { E: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 1: 1 } } },
                            { text: "默默完成最多事情但不爭功", scores: { mbti: { I: 1, S: 2, T: 1, P: 1 }, enneagram: { 6: 2, 5: 1 } } },
                            { text: "用故事鼓舞大家的心", scores: { mbti: { E: 1, N: 1, F: 2, J: 1 }, enneagram: { 2: 2, 7: 1 } } }
                        ]
                    },
                    {
                        question: "6. 評審說你很像「甜點系」食物，這會影響你的隊伍分工，你怎麼回應？",
                        options: [
                            { text: "「謝謝誇獎，我也覺得我很香！」", scores: { mbti: { E: 2, S: 1, F: 1, P: 1 }, enneagram: { 3: 2, 7: 1 } } },
                            { text: "「我其實是鹹的，別誤會我了」", scores: { mbti: { I: 1, S: 2, T: 1, J: 1 }, enneagram: { 1: 2, 8: 1 } } },
                            { text: "「你覺得像甜的，是因為你不懂我。」", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 9: 1 } } },
                            { text: "「那我就來發揮甜點的最大價值！」", scores: { mbti: { E: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 3: 1 } } }
                        ]
                    },
                    {
                        question: "7. 比賽中遇到一個關鍵選擇，你的隊伍需要決定下一步策略，你通常怎麼做？",
                        options: [
                            { text: "分析利弊再決定", scores: { mbti: { I: 1, N: 2, T: 1, J: 1 }, enneagram: { 1: 2, 5: 1 } } },
                            { text: "聽從直覺與情緒", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 7: 1 } } },
                            { text: "問朋友大家意見如何", scores: { mbti: { E: 1, S: 1, F: 2, J: 1 }, enneagram: { 6: 2, 9: 1 } } },
                            { text: "先衝再說，之後再調整", scores: { mbti: { E: 1, S: 2, P: 1 }, enneagram: { 7: 2, 8: 1 } } }
                        ]
                    },
                    {
                        question: "8.「食物界大戰」的號角即將吹響，你們隊伍準備怎麼應對這場決賽？",
                        options: [
                            { text: "仔細計畫與準備", scores: { mbti: { I: 2, S: 1, J: 1 }, enneagram: { 1: 2, 5: 1 } } },
                            { text: "隨遇而安，適應環境", scores: { mbti: { I: 1, S: 2, P: 1 }, enneagram: { 6: 2, 9: 1 } } },
                            { text: "組織團隊，發揮合作", scores: { mbti: { E: 2, N: 1, F: 1, J: 1 }, enneagram: { 2: 2, 6: 1 } } },
                            { text: "衝鋒陷陣，勇往直前", scores: { mbti: { E: 1, S: 2, P: 1 }, enneagram: { 8: 2, 7: 1 } } }
                        ]
                    },
                ]
            },
            {
                intro: "🧠 **階段三：賽中突發狀況與人際處理** 🧠<br>你的反應和處理方式將決定你的食物人格走向。",
                questions: [
                    {
                        question: "9. 比賽期間，你發現有敵隊的食物作弊，但他們成績斐然，你會？",
                        options: [
                            { text: "錄影檢舉，公平最重要", scores: { mbti: { I: 1, S: 1, T: 2, J: 1 }, enneagram: { 1: 2, 8: 1 } } },
                            { text: "私下找他談談，勸他坦白", scores: { mbti: { I: 1, N: 1, F: 2, J: 1 }, enneagram: { 2: 2, 6: 1 } } },
                            { text: "默默記下來，但不出聲", scores: { mbti: { I: 2, N: 1, T: 1, P: 1 }, enneagram: { 5: 2, 9: 1 } } },
                            { text: "想說這只是遊戲，何必較真", scores: { mbti: { E: 1, S: 2, F: 1, P: 1 }, enneagram: { 7: 2, 3: 1 } } }
                        ]
                    },
                    {
                        question: "10. 評審突然要求你進行一場即興的「食材搭配表演」，你會？",
                        options: [
                            { text: "大膽表演，成為焦點", scores: { mbti: { E: 2, S: 1, P: 1 }, enneagram: { 3: 2, 7: 1 } } },
                            { text: "謹慎準備，求完美", scores: { mbti: { I: 1, S: 1, T: 2, J: 1 }, enneagram: { 1: 2, 5: 1 } } },
                            { text: "發揮創意，玩出新花樣", scores: { mbti: { E: 1, N: 2, P: 1 }, enneagram: { 7: 2, 4: 1 } } },
                            { text: "保持冷靜，穩穩完成", scores: { mbti: { I: 1, S: 2, J: 1 }, enneagram: { 6: 2, 9: 1 } } }
                        ]
                    },
                    {
                        question: "11.你的隊友「玻璃心起司鍋」因為表現不佳而情緒崩潰，你會？",
                        options: [
                            { text: "讓他哭一哭再抱抱", scores: { mbti: { I: 1, S: 1, F: 2, P: 1 }, enneagram: { 2: 2, 9: 1 } } },
                            { text: "直接告訴他「你要堅強一點！」", scores: { mbti: { E: 1, S: 2, T: 1, J: 1 }, enneagram: { 1: 2, 8: 1 } } },
                            { text: "請別人幫我處理，我不想被情緒勒索", scores: { mbti: { I: 2, N: 1, T: 1, P: 1 }, enneagram: { 5: 2, 4: 1 } } },
                            { text: "陪他畫畫聊聊天，轉移情緒", scores: { mbti: { E: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 7: 1 } } }
                        ]
                    },
                    {
                        question: "12. 有同隊的食物搶走了你精心準備的「創意點子」的功勞，你會？",
                        options: [
                            { text: "直接對質，維護自己的權益", scores: { mbti: { E: 1, S: 1, T: 2, J: 1 }, enneagram: { 8: 2, 1: 1 } } },
                            { text: "心裡不滿，但選擇忍耐", scores: { mbti: { I: 1, S: 1, F: 2, P: 1 }, enneagram: { 9: 2, 6: 1 } } },
                            { text: "試著轉移注意力，避免衝突", scores: { mbti: { E: 1, N: 1, F: 2, P: 1 }, enneagram: { 2: 2, 7: 1 } } },
                            { text: "暗自努力證明自己更強", scores: { mbti: { I: 1, N: 1, T: 2, J: 1 }, enneagram: { 1: 2, 3: 1 } } }
                        ]
                    },
                    {
                        question: "13. 你的隊友在某個環節不幸被淘汰了，你會？",
                        options: [
                            { text: "立刻安慰並幫忙", scores: { mbti: { E: 1, N: 1, F: 2, J: 1 }, enneagram: { 2: 2, 6: 1 } } },
                            { text: "默默感到難過，自己也陷入低潮", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 9: 1 } } },
                            { text: "迅速調整策略，繼續前進", scores: { mbti: { I: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 3: 1 } } },
                            { text: "覺得是自然淘汰，沒什麼大不了", scores: { mbti: { I: 1, S: 2, T: 1, P: 1 }, enneagram: { 5: 2, 1: 1 } } }
                        ]
                    },
                    {
                        question: "14. 你發現你暗戀的「米其林主廚」是敵隊的關鍵人物…？",
                        options: [
                            { text: "想辦法和他私下聯絡", scores: { mbti: { E: 1, N: 2, F: 1, P: 1 }, enneagram: { 7: 2, 2: 1 } } },
                            { text: "隱藏情感，專注比賽", scores: { mbti: { I: 2, S: 1, T: 1, J: 1 }, enneagram: { 1: 2, 5: 1 } } },
                            { text: "苦惱又矛盾，心情複雜", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 6: 1 } } },
                            { text: "覺得這是有趣的挑戰", scores: { mbti: { E: 1, S: 2, P: 1 }, enneagram: { 8: 2, 7: 1 } } }
                        ]
                    },
                ]
            },
            {
                intro: "🔥 **階段四：壓力與自省** 🔥<br>探索你如何在壓力下自我反思，以及你最珍視的價值。",
                questions: [
                    {
                        question: "15. 比賽進入最終衝刺，你突然遇到一個預料之外的「食材變質」危機，你的反應是？",
                        options: [
                            { text: "立刻想辦法應對並幫助他人", scores: { mbti: { E: 1, N: 1, F: 2, J: 1 }, enneagram: { 6: 2, 2: 1 } } },
                            { text: "躲起來思考哪裡最安全", scores: { mbti: { I: 2, N: 1, T: 1, P: 1 }, enneagram: { 5: 2, 9: 1 } } },
                            { text: "「這可能是命運的考驗…」開始自省", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 1: 1 } } },
                            { text: "「燃燒吧！我就是火焰！」（勇敢面對危機）", scores: { mbti: { E: 1, S: 2, P: 1 }, enneagram: { 8: 2, 7: 1 } } }
                        ]
                    },{
                        question: "16. 比賽間隙的短暫休息時間，你會如何利用來「充電」？",
                        options: [
                            { text: "獨自沉思，充電休息", scores: { mbti: { I: 2, N: 1, T: 1, J: 1 }, enneagram: { 5: 2, 1: 1 } } },
                            { text: "熱鬧社交，認識新朋友", scores: { mbti: { E: 2, S: 1, P: 1 }, enneagram: { 7: 2, 3: 1 } } },
                            { text: "和熟悉的人聊聊天", scores: { mbti: { I: 1, S: 1, F: 2, J: 1 }, enneagram: { 9: 2, 6: 1 } } },
                            { text: "做點喜歡的小事情放鬆", scores: { mbti: { I: 1, S: 1, F: 2, P: 1 }, enneagram: { 4: 2, 5: 1 } } }
                        ]
                    },
                    {
                        question: "17. 在這場食物生存大賽中，你最害怕失去什麼？",
                        options: [
                            { text: "被忽視與遺忘", scores: { mbti: { I: 1, N: 1, F: 2, P: 1 }, enneagram: { 4: 2, 2: 1 } } },
                            { text: "失控和混亂", scores: { mbti: { E: 1, S: 1, T: 2, P: 1 }, enneagram: { 8: 2, 1: 1 } } },
                            { text: "無用與被拒絕", scores: { mbti: { I: 1, S: 1, T: 2, J: 1 }, enneagram: { 1: 2, 3: 1 } } },
                            { text: "孤獨與被排斥", scores: { mbti: { I: 1, S: 1, F: 2, J: 1 }, enneagram: { 6: 2, 9: 1 } } }
                        ]
                    },
                    {
                        question: "18. 在一場激烈的「食物理念辯論」中，評審問你：「你作為食物，你存在的意義是？」你說？",
                        options: [
                            { text: "「為了讓別人開心、被喜歡！」", scores: { mbti: { E: 1, N: 1, F: 2, P: 1 }, enneagram: { 2: 2, 7: 1 } } },
                            { text: "「為了完成使命，挑戰極限。」", scores: { mbti: { I: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 3: 1 } } },
                            { text: "「沒有意義，但我會自己創造。」", scores: { mbti: { I: 1, N: 2, F: 1, P: 1 }, enneagram: { 4: 2, 5: 1 } } },
                            { text: "我是提供解決方案的那個人。」", scores: { mbti: { I: 1, S: 1, T: 2, J: 1 }, enneagram: { 5: 2, 1: 1 } } }
                        ]
                    },
                ]
            },
            {
                intro: "🏆 **階段五：決賽與最終定論** 🏆<br>你的選擇將引導你揭示你的終極食物人格。",
                questions: [
                    {
                        question: "19. 經過這場風味大戰的洗禮，如果可以選擇「風味重生」，你會選擇成為怎樣的食物？",
                        options: [
                            { text: "沒人認得我，我可以重新定義自己", scores: { mbti: { I: 1, N: 2, F: 1, P: 1 }, enneagram: { 4: 2, 7: 1 } } },
                            { text: "功能強大、受人倚賴的角色", scores: { mbti: { E: 1, S: 1, T: 2, J: 1 }, enneagram: { 3: 2, 8: 1 } } },
                            { text: "可愛又有人保護我", scores: { mbti: { I: 1, S: 1, F: 2, P: 1 }, enneagram: { 6: 2, 2: 1 } } },
                            { text: "跟現在一樣，我覺得我不錯", scores: { mbti: { I: 1, S: 2, F: 1, J: 1 }, enneagram: { 9: 2, 1: 1 } } }
                        ]
                    },
                    {
                        question: "20. 最終評審對你進行了定義，宣布你屬於某種「食物人格」。你的反應是？",
                        options: [
                            { text: "接受這個定義，努力做好自己", scores: { mbti: { I: 1, S: 2, F: 1, J: 1 }, enneagram: { 9: 2, 6: 1 } } },
                            { text: "挑戰評審，證明自己不同", scores: { mbti: { I: 1, N: 1, T: 2, J: 1 }, enneagram: { 8: 2, 1: 1 } } },
                            { text: "重新定義自己，開創新路", scores: { mbti: { I: 1, N: 2, F: 1, P: 1 }, enneagram: { 4: 2, 7: 1 } } },
                            { text: "笑看結果，隨緣自在", scores: { mbti: { E: 1, N: 2, F: 1, P: 1 }, enneagram: { 7: 2, 9: 1 } } }
                        ]
                    }
                ]
            }
        ];

        // 食物人格定義
        const foodPersonalities = {
            macaron: {
                name: '馬卡龍',
                emoji: '🍬',
                description: '你像馬卡龍一樣，充滿了繽紛的想像力與對世界的好奇心。你熱情、樂觀，並且善於表達情感，總能為周遭帶來歡樂與活力。'
            },
            tofuPudding: {
                name: '豆花',
                emoji: '🍮',
                description: '你像豆花一樣溫潤而平易近人，擁有一顆柔軟且富有同理心的心。你樂於助人，善於傾聽，是朋友和家人心中最溫暖的港灣。'
            },
            grilledCheeseSandwich: {
                name: '熱壓吐司',
                emoji: '🥪',
                description: '你像熱壓吐司一樣，外表酥脆，內心柔軟而充實。你務實、可靠，總能給人帶來安全感，並且在關鍵時刻展現出你的韌性。'
            },
            blackCoffee: {
                name: '黑咖啡',
                emoji: '☕',
                description: '你像黑咖啡一樣，沉穩、理性，具有深度。你喜歡獨立思考，追求事物的本質，並且在面對挑戰時展現出堅定的意志。'
            },
            popcorn: {
                name: '爆米花',
                emoji: '🍿',
                description: '你像爆米花一樣，充滿了活力與驚喜。你熱愛自由，喜歡嘗試新事物，並且總能用你的熱情感染周遭的人。'
            },
            cottonCandy: {
                name: '棉花糖',
                emoji: '☁️',
                description: '你像棉花糖一樣，輕盈、柔軟，充滿了夢幻。你敏感、富有想像力，並且擁有一顆純真善良的心，總能為世界帶來一絲甜蜜。'
            },
            zucchini: {
                name: '櫛瓜',
                emoji: '🥒',
                description: '你像櫛瓜一樣，清新、自然，內斂而有深度。你冷靜、理性，善於分析，並且總能保持客觀的態度看待事物。'
            },
            cheeseFondue: {
                name: '起司鍋',
                emoji: '🫕',
                description: '你像起司鍋一樣，濃郁、熱情，充滿了感染力。你果斷、有行動力，並且總能帶領團隊邁向成功。'
            },
            roastedSweetPotato: {
                name: '烤地瓜',
                emoji: '🍠',
                description: '你像烤地瓜一樣，溫暖、踏實，給人一種安心的感覺。你內斂、真誠，並且擁有堅韌的生命力，總能默默地支持身邊的人。'
            }
        };

        // 隨機理由列表 (這些文字將不再顯示在卡片上，但保留在程式碼中以防未來需要)
        const suitableReasons = [
            "因為你們都喜歡在週末輕鬆聚會。",
            "你們總能理解彼此的幽默感。",
            "在困難時，你們會互相支持。",
            "你們對世界充滿好奇，喜歡一起探索新事物。",
            "你們在一起時，總能找到平靜和滿足。"
        ];

        const unsuitableReasons = [
            "他們的步調可能與你不太一致。",
            "你們對事物的看法可能存在較大差異。",
            "在某些情況下，你們的溝通方式可能需要磨合。",
            "他們喜歡的活動或許不是你的菜。",
            "你們在面對壓力時，反應方式可能截然不同。"
        ];

        // 輔助函數：獲取問題在所有階段中的全局索引
        function getQuestionGlobalIndex(stageIndex, questionIndexInStage) {
            let globalIndex = 0;
            for (let i = 0; i < stageIndex; i++) {
                globalIndex += stages[i].questions.length;
            }
            return globalIndex + questionIndexInStage;
        }

        // 渲染當前階段的問題
        function renderStage() {
            const currentStage = stages[currentStageIndex];
            currentStageContent.innerHTML = '';

            // 更新進度指示器
            const progressIndicator = document.getElementById('stage-progress');
            progressIndicator.innerText = `階段 ${currentStageIndex + 1} / ${stages.length}`; // 顯示階段進度

            // 添加階段引文
            if (currentStage.intro) {
                const introDiv = document.createElement('div');
                introDiv.className = 'stage-intro';
                introDiv.innerHTML = `<p>${currentStage.intro}</p>`;
                currentStageContent.appendChild(introDiv);
            }

            // 渲染問題
            currentStage.questions.forEach((q, qIndex) => {
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                const questionText = document.createElement('p');
                questionText.className = 'question-text';
                questionText.innerText = q.question;
                questionBlock.appendChild(questionText);

                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';

                q.options.forEach((option, optionIndex) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.innerText = option.text;
                    optionBtn.dataset.questionIndexInStage = qIndex;
                    optionBtn.dataset.optionIndex = optionIndex;

                    const globalQuestionIndex = getQuestionGlobalIndex(currentStageIndex, qIndex);
                    if (userAnswers[globalQuestionIndex] === optionIndex) {
                        optionBtn.classList.add('selected');
                    }

                    optionBtn.addEventListener('click', selectOption);
                    optionsContainer.appendChild(optionBtn);
                });
                questionBlock.appendChild(optionsContainer);
                currentStageContent.appendChild(questionBlock);
            });

            updateNavigationButtons();
            window.scrollTo(0, 0); // 滾動到頁面頂部
        }

        // 處理選項選擇
        function selectOption(event) {
            const selectedBtn = event.target;
            const questionIndexInStage = parseInt(selectedBtn.dataset.questionIndexInStage);
            const optionIndex = parseInt(selectedBtn.dataset.optionIndex);
            const globalQuestionIndex = getQuestionGlobalIndex(currentStageIndex, questionIndexInStage);

            // 移除同問題其他選項的 selected 狀態
            const options = selectedBtn.closest('.options-container').querySelectorAll('.option-btn');
            options.forEach(btn => btn.classList.remove('selected'));

            // 添加當前選項的 selected 狀態
            selectedBtn.classList.add('selected');

            // 儲存用戶答案
            userAnswers[globalQuestionIndex] = optionIndex;

            updateNavigationButtons(); // 每次選擇後更新按鈕狀態
        }

        // 更新導航按鈕狀態 (上一階段/下一階段/查看結果)
        function updateNavigationButtons() {
            // 上一階段按鈕
            if (currentStageIndex > 0) {
                prevStageBtn.classList.remove('hidden');
            } else {
                prevStageBtn.classList.add('hidden');
            }

            // 下一階段/查看結果按鈕
            const currentStageQuestions = stages[currentStageIndex].questions;
            let allAnsweredInCurrentStage = true;
            for (let i = 0; i < currentStageQuestions.length; i++) {
                const globalIndex = getQuestionGlobalIndex(currentStageIndex, i);
                if (userAnswers[globalIndex] === undefined) {
                    allAnsweredInCurrentStage = false;
                    break;
                }
            }

            if (currentStageIndex === stages.length - 1) {
                nextStageBtn.innerText = '查看結果';
                nextStageBtn.dataset.direction = 'result';
            } else {
                nextStageBtn.innerText = '下一階段';
                nextStageBtn.dataset.direction = 'next';
            }

            // 根據是否所有問題都已回答來啟用/禁用按鈕
            if (!allAnsweredInCurrentStage) {
                nextStageBtn.classList.add('disabled');
                nextStageBtn.disabled = true;
            } else {
                nextStageBtn.classList.remove('disabled');
                nextStageBtn.disabled = false;
            }
        }

        // 導航到下一階段或上一階段
        function navigateStage(direction) {
            if (direction === 'next') {
                if (currentStageIndex < stages.length - 1) {
                    currentStageIndex++;
                    renderStage();
                }
            } else if (direction === 'result') {
                calculateAndShowResult();
            } else if (direction === 'prev') {
                if (currentStageIndex > 0) {
                    currentStageIndex--;
                    renderStage();
                }
            }
        }

        // 重新計算 MBTI 和九型人格分數 (雖然結果隨機，但保留此函數以供數據傳輸)
        function recalculateScores() {
            mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

            let globalCounter = 0;
            stages.forEach(stage => {
                stage.questions.forEach((q, qIndex) => {
                    const selectedOptionIndex = userAnswers[globalCounter];
                    if (selectedOptionIndex !== undefined) {
                        const selectedOption = q.options[selectedOptionIndex];
                        // 累計 MBTI 分數
                        for (const key in selectedOption.scores.mbti) {
                            mbtiScores[key] += selectedOption.scores.mbti[key];
                        }
                        // 累計九型人格分數
                        for (const key in selectedOption.scores.enneagram) {
                            enneagramScores[key] += selectedOption.scores.enneagram[key];
                        }
                    }
                    globalCounter++;
                });
            });
        }

        // 計算最終 MBTI 類型 (保留此函數以供數據傳輸)
        function calculateMBTI() {
            const e_i = mbtiScores.E >= mbtiScores.I ? 'E' : 'I';
            const s_n = mbtiScores.S >= mbtiScores.N ? 'S' : 'N';
            const t_f = mbtiScores.T >= mbtiScores.F ? 'T' : 'F';
            const j_p = mbtiScores.J >= mbtiScores.P ? 'J' : 'P';
            return e_i + s_n + t_f + j_p;
        }

        // 計算最終九型人格類型 (保留此函數以供數據傳輸)
        function calculateEnneagram() {
            let maxScore = -1;
            let maxType = '';
            for (const type in enneagramScores) {
                if (enneagramScores[type] > maxScore) {
                    maxScore = enneagramScores[type];
                    maxType = type;
                } else if (enneagramScores[type] === maxScore) {
                    // 如果分數相同，優先選擇數字較小的類型 (作為一個規則)
                    if (parseInt(type) < parseInt(maxType)) {
                        maxType = type;
                    }
                }
            }
            return maxType ? `${maxType}號` : '未知類型';
        }

        // 隨機獲取 N 個不同的元素 (不包含特定元素)
        function getRandomUniqueElements(arr, count, excludeKeys = []) {
            const result = [];
            const available = arr.filter(key => !excludeKeys.includes(key));
            while (result.length < count && available.length > 0) {
                const randomIndex = Math.floor(Math.random() * available.length);
                result.push(available.splice(randomIndex, 1)[0]);
            }
            return result;
        }

        // 計算並顯示結果
        function calculateAndShowResult() {
            recalculateScores();

            quizContainer.classList.add('hidden');
            introContainer.classList.add('hidden');
            moreDetailsContainer.classList.add('hidden'); // 確保更多詳情頁隱藏
            resultContainer.classList.remove('hidden');
            window.scrollTo(0, 0);

            const finalMBTI = calculateMBTI();
            const finalEnneagram = calculateEnneagram();
            console.log("最終 MBTI 類型: ", finalMBTI);
            console.log("最終九型人格類型: ", finalEnneagram);
            console.log("MBTI 原始分數: ", mbtiScores);
            console.log("九型人格原始分數: ", enneagramScores);

            // 核心修改：食物人格完全隨機選擇
            const allFoodKeys = Object.keys(foodPersonalities);
            const finalFoodPersonalityKey = allFoodKeys[Math.floor(Math.random() * allFoodKeys.length)];
            const matchedFood = foodPersonalities[finalFoodPersonalityKey];

            finalFoodPersonalityElement.innerHTML = `<span class="emoji">${matchedFood.emoji}</span> ${matchedFood.name}`;
            foodPersonalityDescriptionElement.innerText = matchedFood.description;

            // 顯示用戶姓名
            document.getElementById('userNameDisplay').innerText = userName || '你';

            // 隨機生成適合和不適合的食物
            const numSuitable = Math.floor(Math.random() * 2) + 2; // 2或3個
            const numUnsuitable = Math.floor(Math.random() * 2) + 2; // 2或3個

            const suitableFoodKeys = getRandomUniqueElements(allFoodKeys, numSuitable, [finalFoodPersonalityKey]);
            const unsuitableFoodKeys = getRandomUniqueElements(allFoodKeys, numUnsuitable, [finalFoodPersonalityKey, ...suitableFoodKeys]);

            // 清空並填充適合的食物網格
            suitableFoodsGrid.innerHTML = '';
            if (suitableFoodKeys.length > 0) {
                suitableFoodKeys.forEach(key => {
                    const food = foodPersonalities[key];
                    // 移除了 randomReason 的顯示，只保留食物名稱和 emoji
                    const foodCard = document.createElement('div');
                    foodCard.className = 'food-card';
                    foodCard.innerHTML = `
                        <span class="emoji">${food.emoji}</span>
                        <strong>${food.name}</strong>
                    `;
                    suitableFoodsGrid.appendChild(foodCard);
                });
            } else {
                const noFoodMessage = document.createElement('p');
                noFoodMessage.className = 'reason-text';
                noFoodMessage.innerText = '目前沒有特別合拍的食物。';
                suitableFoodsGrid.appendChild(noFoodMessage);
            }

            // 清空並填充不適合的食物網格
            unsuitableFoodsGrid.innerHTML = '';
            if (unsuitableFoodKeys.length > 0) {
                unsuitableFoodKeys.forEach(key => {
                    const food = foodPersonalities[key];
                    // 移除了 randomReason 的顯示，只保留食物名稱和 emoji
                    const foodCard = document.createElement('div');
                    foodCard.className = 'food-card';
                    foodCard.innerHTML = `
                        <span class="emoji">${food.emoji}</span>
                        <strong>${food.name}</strong>
                    `;
                    unsuitableFoodsGrid.appendChild(foodCard);
                });
            } else {
                const noFoodMessage = document.createElement('p');
                noFoodMessage.className = 'reason-text';
                noFoodMessage.innerText = '目前沒有特別需要多點理解的食物。';
                unsuitableFoodsGrid.appendChild(noFoodMessage);
            }

            // 觸發圖片生成和顯示
            generateAndDisplayResultImage(matchedFood, finalMBTI, finalEnneagram);
        }

        // 生成並顯示結果圖片
        function generateAndDisplayResultImage(matchedFood, mbti, enneagram) {
            // 在截圖前，確保回饋區塊、下載按鈕、更多詳情按鈕是隱藏的，避免截圖到
            feedbackSection.classList.add('hidden');
            if (downloadImageBtn) downloadImageBtn.classList.add('hidden');
            saveImageHintText.classList.add('hidden');
            viewMoreDetailsBtn.classList.add('hidden'); // 隱藏更多詳情按鈕

            html2canvas(screenshotArea, {
                useCORS: true,
                allowTaint: true,
                scale: 2, // 提高解析度
                backgroundColor: '#fdfdfd' // 設定背景色
            }).then(canvas => {
                const dataURL = canvas.toDataURL('image/png');
                resultImagePreview.src = dataURL;

                // 截圖完成後，隱藏原始的文字結果區塊
                screenshotArea.classList.add('hidden');

                // 顯示圖片預覽區塊
                document.getElementById('image-display-area').classList.remove('hidden');

                // 顯示回饋區塊和操作按鈕
                feedbackSection.classList.remove('hidden');
                if (downloadImageBtn) {
                    downloadImageBtn.classList.remove('hidden'); // 顯示下載按鈕
                    downloadImageBtn.href = dataURL;
                    downloadImageBtn.download = `${userName || '我的食物人格'}_測驗結果.png`;
                }
                saveImageHintText.classList.remove('hidden'); // 顯示手機長按提示

            }).catch(error => {
                console.error("圖片生成失敗：", error);
                alert("圖片生成失敗，請重試。");
                // 即使失敗也要確保操作區塊和回饋區塊可見
                feedbackSection.classList.remove('hidden');
                if (downloadImageBtn) downloadImageBtn.classList.remove('hidden');
                saveImageHintText.classList.remove('hidden');
                screenshotArea.classList.remove('hidden'); // 失敗時不隱藏原始文字區塊
            });
        }


        // 事件監聽器
        startQuizBtn.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            introContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            currentStageIndex = 0; // 重置階段索引
            userAnswers = {}; // 清空答案
            renderStage();
        });

        nextStageBtn.addEventListener('click', (event) => {
            navigateStage(event.target.dataset.direction);
        });

        prevStageBtn.addEventListener('click', (event) => {
            navigateStage(event.target.dataset.direction);
        });

        // 結果頁的重新測驗按鈕
        restartQuizBtn.addEventListener('click', () => {
            resetQuiz();
        });

        // 更多詳情頁的重新測驗按鈕
        restartQuizBtnFromDetails.addEventListener('click', () => {
            resetQuiz();
        });

        // 重置測驗狀態的函數
        function resetQuiz() {
            resultContainer.classList.add('hidden');
            moreDetailsContainer.classList.add('hidden'); // 確保更多詳情頁隱藏
            introContainer.classList.remove('hidden');
            userNameInput.value = ''; // 清空姓名
            currentStageIndex = 0; // 重置階段索引
            userAnswers = {}; // 清空答案
            mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            enneagramScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };

            // 重置回饋按鈕狀態
            feedbackButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.disabled = false;
            });
            // 隱藏圖片預覽和下載按鈕/提示
            resultImagePreview.src = ''; // 清空圖片源
            if (downloadImageBtn) downloadImageBtn.classList.add('hidden');
            saveImageHintText.classList.add('hidden');
            
            // 確保回饋區塊和查看更多按鈕在重新測驗時是初始狀態
            feedbackSection.classList.remove('hidden'); // 顯示回饋區塊
            viewMoreDetailsBtn.classList.add('hidden'); // 隱藏查看更多按鈕
            screenshotArea.classList.remove('hidden'); // 重新測驗時顯示截圖區域，以便下次生成圖片
            document.getElementById('image-display-area').classList.add('hidden'); // 隱藏圖片顯示區塊
        }


        feedbackButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                // 視覺回饋：立即隱藏回饋區塊，顯示更多詳情按鈕
                feedbackButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                feedbackSection.classList.add('hidden'); // 立即隱藏回饋區塊
                viewMoreDetailsBtn.classList.remove('hidden'); // 顯示查看更多按鈕

                const feedbackType = event.target.dataset.feedback;
                const finalMBTI = calculateMBTI(); // 再次計算以確保數據最新
                const finalEnneagram = calculateEnneagram();
                const finalFoodPersonality = finalFoodPersonalityElement.innerText.replace(/[\uD800-\uDBFF\uDC00-\uDFFF]/g, '').trim(); // 移除 emoji

                const dataToSend = {
                    userName: userName,
                    foodPersonality: finalFoodPersonality,
                    mbtiType: finalMBTI,
                    enneagramType: finalEnneagram,
                    feedback: feedbackType
                };

                const backendApiUrl = 'https://food-quiz-python-backend.onrender.com/api/feedback'; // 確認 API URL

                fetch(backendApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend),
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || '回饋發送失敗');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('回饋成功:', data);
                    // alert('感謝您的回饋！'); // 移除彈窗，因為現在有更多詳情按鈕
                })
                .catch((error) => {
                    console.error('回饋發送錯誤:', error);
                    alert(`回饋發送失敗：${error.message}，請稍後再試。`);
                });
            });
        });

        // 查看更多詳情按鈕事件
        viewMoreDetailsBtn.addEventListener('click', () => {
            resultContainer.classList.add('hidden');
            moreDetailsContainer.classList.remove('hidden');
            window.scrollTo(0, 0); // 滾動到頁面頂部
        });

        // 複製連結按鈕事件
        copyLinkBtn.addEventListener('click', () => {
            shareLinkInput.select(); // 選中文字
            shareLinkInput.setSelectionRange(0, 99999); // 針對行動裝置

            // 使用 document.execCommand('copy') 進行複製
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? '連結已複製！' : '複製失敗，請手動複製。';
                alert(msg);
            } catch (err) {
                console.error('複製失敗:', err);
                alert('複製失敗，請手動複製。');
            }
        });


        // 初始化：確保頁面加載時顯示歡迎頁面
        document.addEventListener('DOMContentLoaded', () => {
            introContainer.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            moreDetailsContainer.classList.add('hidden'); // 確保更多詳情頁預設隱藏

            // 確保初始狀態下下載按鈕和手機提示是隱藏的
            if (downloadImageBtn) downloadImageBtn.classList.add('hidden');
            saveImageHintText.classList.add('hidden');
            screenshotArea.classList.remove('hidden'); // 確保初始時截圖區域是可見的
            document.getElementById('image-display-area').classList.add('hidden'); // 隱藏圖片顯示區塊
            feedbackSection.classList.remove('hidden'); // 確保回饋區塊可見
            viewMoreDetailsBtn.classList.add('hidden'); // 確保查看更多按鈕隱藏
        });

        // JavaScript 代碼結束
    </script>
</body>
</html>
